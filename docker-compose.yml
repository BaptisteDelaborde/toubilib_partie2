networks:
  toubilib.net:
    driver: bridge

services:
  #Api gateaway
  api_gateway:
    build:
      context: build
      dockerfile: 8.4-cli.Dockerfile
    ports:
      - '8081:80'
    volumes:
      - ./api_gateway:/var/php
    working_dir: /var/php
    networks:
      - toubilib.net
    command: sh -c "composer install && php -S 0.0.0.0:80 -t /var/php/public"

  # service api.toubeelib : api pour la prise de rdv
  #
  api.toubilib:
    build:
      context: build
      dockerfile: 8.4-cli.Dockerfile
    ports:
      - '6080:80'
    volumes:
      - ./app:/var/php
    working_dir: /var/php
    networks:
      - toubilib.net
    depends_on:
      - toubiprati.db
      - toubiauth.db
    command: sh -c "composer install --ignore-platform-reqs || composer update --no-interaction --ignore-platform-reqs && php -S 0.0.0.0:80 -t /var/php/public"

  # service app-praticiens : microservice pour la gestion des praticiens
  app-praticiens:
    build:
      context: build
      dockerfile: 8.4-cli.Dockerfile
    ports:
      - '6081:80'
    volumes:
      - ./app-praticiens:/var/php
    working_dir: /var/php
    networks:
      - toubilib.net
    depends_on:
      - toubiprati.db
    command: sh -c "composer install && php -S 0.0.0.0:80 -t /var/php/public"

  # service app-rdv : microservice pour la gestion des rendez-vous
  app-rdv:
    build:
      context: build
      dockerfile: 8.4-cli.Dockerfile
    ports:
      - '6082:80'
    volumes:
      - ./app-rdv:/var/php
    working_dir: /var/php
    networks:
      - toubilib.net
    depends_on:
      - toubirdv.db
    command: sh -c "composer install && php -S 0.0.0.0:80 -t /var/php/public"

  # service app-auth : microservice pour l'authentification
  app-auth:
    build:
      context: build
      dockerfile: 8.4-cli.Dockerfile
    ports:
      - '6084:80'
    volumes:
      - ./app-auth:/var/php
    working_dir: /var/php
    networks:
      - toubilib.net
    depends_on:
      - toubiauth.db
    command: sh -c "composer install && php -S 0.0.0.0:80 -t /var/php/public"

  # service toubiprat.db : base de donn√©es postgresql pour les praticiens

  toubiprati.db:
    image: 'postgres:latest'
    env_file: ./toubipratdb.env
    ports:
      - '5432:5432'
    networks:
      - toubilib.net
    volumes:
      - ./sql/toubiprat.schema.sql:/docker-entrypoint-initdb.d/01.schema.sql
      - ./sql/toubiprat.data.sql:/docker-entrypoint-initdb.d/02.data.sql

  toubiauth.db:
    image: 'postgres:latest'
    env_file: ./toubiauthdb.env
    ports:
      - '5433:5432'
    networks:
      - toubilib.net
    volumes:
      - ./sql/toubiauth.schema.sql:/docker-entrypoint-initdb.d/03.schema.sql
      - ./sql/toubiauth.data.sql:/docker-entrypoint-initdb.d/04.data.sql

  toubirdv.db:
    image: 'postgres:latest'
    env_file: ./toubirdvdb.env
    ports:
      - '5434:5432'
    networks:
      - toubilib.net
    volumes:
      - ./sql/toubirdv.schema.sql:/docker-entrypoint-initdb.d/05.schema.sql
      - ./sql/toubirdv.data.sql:/docker-entrypoint-initdb.d/06.data.sql

  toubipat.db:
    image: 'postgres:latest'
    env_file: ./toubipatientdb.env
    ports:
      - '5435:5432'
    networks:
      - toubilib.net
    volumes:
      - ./sql/toubipat.schema.sql:/docker-entrypoint-initdb.d/03.schema.sql
      - ./sql/toubipat.data.sql:/docker-entrypoint-initdb.d/04.data.sql


  #
  # service administration des bases sql
  #
  adminer:
    image: adminer
    ports:
      - '8080:8080'
    networks:
      - toubilib.net


#######################################
### RabbitMQ Service
###
#######################################
rabbitmq:
  image: rabbitmq:4-management
  #    build:
  #      context: build
  #      dockerfile: rabbit-stomp.Dockerfile
  ports:
    - '15672:15672'
    #      - '15674:15674'
    - '5672:5672'
  healthcheck:
    test: rabbitmq-diagnostics -q ping
    interval: 8s
    timeout: 30s
    retries: 3
  networks:
    - toubilib.net
  volumes:
    - ./rabbitmq.toubi:/var/lib/rabbitmq
  environment:
    - RABBITMQ_DEFAULT_USER: toubi
    - RABBITMQ_DEFAULT_PASS: toubi

#################################################
#
# Ajouter dans les services qui utilisent le serveur rabbitmq :
#      depends_on:
#        rabbitmq:
#           condition: service_healthy

##############################################
###
###  MailCatcher
###############################################
mail.toubi:
  build:
    context: build
    dockerfile: mailcatcher.Dockerfile
  networks:
    - toubilib.net
  ports:
    - '1080:1080'

